---
title:  消息队列
date: 2019-11-27 15:04:37
categories:
- 后端知识
tags:
comments: false
---

### 什么是消息队列？

消息队列——MQ(Message Queue)。可以看成是一个存放消息的容器，当我们需要使用消息时候可以取出消息供自己使用。

<!-- more -->

### 优点

#### 1. 解耦

利用发布-订阅模式工作，消息发送者（生产者）发布消息，一个或多个消息接受者（消费者）订阅消息，订阅者消费者不直接接触，而是通过消息队列进行处理数据输出数据。

另外为了避免消息队列服务器宕机造成消息丢失，会将成功发送到消息队列的消息存储在消息生产者服务器上，等消息真正被消费者服务器处理后才删除消息。在消息队列服务器宕机后，生产者服务器会选择分布式消息队列服务器集群中的其他服务器发布消息。

![img](https://s4.51cto.com/oss/201904/15/1657e6a177e2aa8f6223ea9544523ac5.jpg)

#### 2. 异步

将不是必须的业务逻辑，异步处理，提高性能

![img](http://images2015.cnblogs.com/blog/270324/201607/270324-20160730141236169-1140938329.png)

#### 3. 削峰/限流

流量削锋是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛

a、可以控制活动的人数
b、可以缓解短时间内高流量压垮应用

![img](http://images2015.cnblogs.com/blog/270324/201607/270324-20160730151710106-2043115158.png)

用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面。秒杀业务根据消息队列中的请求信息，再做后续处理

#### 4. 日志处理

将消息队列用在日志处理中，比如Kafka的应用，解决大量日志传输的问题。架构简化如下
![img](http://images2015.cnblogs.com/blog/270324/201607/270324-20160730152810934-1818295010.png)
日志采集客户端，负责日志数据采集，定时写受写入Kafka队列
Kafka消息队列，负责日志数据的接收，存储和转发
日志处理应用：订阅并消费kafka队列中的日志数据 

#### 5. 消息通讯
消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等
点对点通讯：
![img](http://images2015.cnblogs.com/blog/270324/201607/270324-20160730153544294-1894255488.png)
客户端A和客户端B使用同一队列，进行消息通讯。

x：
![img](http://images2015.cnblogs.com/blog/270324/201607/270324-20160730153550184-1160563716.png)
客户端A，客户端B，客户端N订阅同一主题，进行消息发布和接收。实现类似聊天室效果。

以上实际是消息队列的两种消息模式，点对点或发布订阅模式



### 缺点

#### 1. 系统可用性降低

万一MQ挂了。。。

#### 2. 系统复杂性降低

需要保证消息没有被重复消费，保证不被丢失，保证顺序性等等

#### 3. 一致性问题

在异步的情况下，假如消费者没有正常消费，就会出现数据不一致的情况



### 选型

关于选型，因为自己还没有实践经验，摘录了网上原文，以供记录：

> ActiveMQ 的社区算是比较成熟，但是较目前来说，ActiveMQ 的性能比较差，而且版本迭代很慢，不推荐使用。
>
> RabbitMQ 在吞吐量方面虽然稍逊于 Kafka 和 RocketMQ ，但是由于它基于 erlang 开发，所以并发能力很强，性能极其好，延时很低，达到微秒级。但是也因为 RabbitMQ 基于 erlang 开发，所以国内很少有公司有实力做erlang源码级别的研究和定制。如果业务场景对并发量要求不是太高（十万级、百万级），那这四种消息队列中，RabbitMQ 一定是你的首选。如果是大数据领域的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。
>
> RocketMQ 阿里出品，Java 系开源项目，源代码我们可以直接阅读，然后可以定制自己公司的MQ，并且 RocketMQ 有阿里巴巴的实际业务场景的实战考验。RocketMQ 社区活跃度相对较为一般，不过也还可以，文档相对来说简单一些，然后接口这块不是按照标准 JMS 规范走的有些系统要迁移需要修改大量代码。还有就是阿里出台的技术，你得做好这个技术万一被抛弃，社区黄掉的风险，那如果你们公司有技术实力我觉得用RocketMQ 挺好的
>
> kafka 的特点其实很明显，就是仅仅提供较少的核心功能，但是提供超高的吞吐量，ms 级的延迟，极高的可用性以及可靠性，而且分布式可以任意扩展。同时 kafka 最好是支撑较少的 topic 数量即可，保证其超高吞吐量。kafka 唯一的一点劣势是有可能消息重复消费，那么对数据准确性会造成极其轻微的影响，在大数据领域中以及日志采集中，这点轻微影响可以忽略这个特性天然适合大数据实时计算以及日志收集。