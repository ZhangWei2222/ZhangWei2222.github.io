---
title: vue-axioså–æ¶ˆé‡å¤è¯·æ±‚å®ç°å’ŒåŸç†
date: 2021-08-23 18:40:47
categories:
- Vue
comments: true
---

## å–æ¶ˆè¯·æ±‚çš„åŸºæœ¬å®ç°

axios åº•å±‚æ˜¯åˆ©ç”¨ XMLHttpRequest å¯¹è±¡æ¥å‘èµ· HTTP è¯·æ±‚ã€‚å¦‚æœè¦å–æ¶ˆè¯·æ±‚çš„è¯ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ XMLHttpRequest å¯¹è±¡ä¸Šçš„ `abort` æ–¹æ³•æ¥å–æ¶ˆè¯·æ±‚ï¼š

```js
 let xhr = new XMLHttpRequest();
 xhr.open("GET", "http://localhost:3000/demo", true);
 xhr.send();
```

å¯¹äºaxios,é€šè¿‡axioså†…éƒ¨çš„ CancelTokenæ¥å–æ¶ˆè¯·æ±‚
```js
var CancelToken = axios.CancelToken;
var source = CancelToken.source();
axios.get('http://localhost:3000/demo', {
  cancelToken: source.token
})
setTimeout(() => {
  source.cancel('Operation canceled by the user.'); // å–æ¶ˆè¯·æ±‚ï¼Œå‚æ•°æ˜¯å¯é€‰çš„
}, 1000)


// post è¯·æ±‚
axios.post('http://localhost:3000/postDemo', JSON.stringify({}), {
  cancelToken: source.token
})

setTimeout(() => {
  source.cancel('Operation canceled by the user.'); // å–æ¶ˆè¯·æ±‚ï¼Œå‚æ•°æ˜¯å¯é€‰çš„
}, 1000) 
ä¹Ÿå¯ä»¥ä½¿ç”¨CancelTokençš„æ„é€ å‡½æ•°æ¥åˆ›å»ºCancelToken
axios.get('http://localhost:3000/demo', {
  cancelToken: new CancelToken(function executor(c) {
    cancel = c;
  })
});
setTimeout(() => {
  cancel();
}, 1000)
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹ CancelTokenæ˜¯å¦‚ä½•å®ç°çš„



## CancelTokenå·¥ä½œåŸç†

```js
function CancelToken(executor) {
  if (typeof executor !== 'function') {
    throw new TypeError('executor must be a function.');
  }

  var resolvePromise;
  this.promise = new Promise(function promiseExecutor(resolve) {
    resolvePromise = resolve;
  });

  var token = this;
  executor(function cancel(message) {  // ğŸ¥ è®¾ç½®cancelå¯¹è±¡
    if (token.reason) {
      // Cancellation has already been requested
      return;
    }
    // ğŸ¥ åˆ›å»ºCancelå¯¹è±¡ å¹¶è°ƒç”¨resolvePromise
    // CancelTokenå¯¹è±¡çš„promiseå°±æ˜¯ resolved

    token.reason = new Cancel(message);
    resolvePromise(token.reason);
  });
}
```
cancelå¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨ä¹‹åä¼šåˆ›å»ºCancelå¯¹è±¡å¹¶ä¸”ä¼šè°ƒç”¨resovlePromiseæ–¹æ³•ã€‚CancelTokenå¯¹è±¡ä¸Šçš„promiseå±æ€§å°±ä¼šå˜æˆ resolved
```js
if (config.cancelToken) {
  // Handle cancellation
  config.cancelToken.promise.then(function onCanceled(cancel) {
    if (!request) {
      return;
    }
    // ğŸ¥  è¿›å…¥äº† then çš„é€»è¾‘ï¼Œå–æ¶ˆè¯·æ±‚
    request.abort();
    reject(cancel);
    // Clean up request
    request = null;
  });
}
```


## å–æ¶ˆé‡å¤demo

é¦–å…ˆå‰ç«¯å°±éœ€è¦è¿›è¡Œåˆ¤æ–­è¯·æ±‚ï¼Œåœ¨çŸ­æ—¶é—´å†…è¯·æ±‚æ–¹å¼ã€è¯·æ±‚ URL åœ°å€å’Œè¯·æ±‚å‚æ•°éƒ½ä¸€æ ·æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºè¯·æ±‚æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤åœ¨æ¯æ¬¡å‘èµ·è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å½“å‰è¯·æ±‚çš„è¯·æ±‚æ–¹å¼ã€è¯·æ±‚ URL åœ°å€å’Œè¯·æ±‚å‚æ•°æ¥ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ keyï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªä¸“å±çš„ CancelTokenå¯¹è±¡ï¼Œç„¶åæŠŠ key å’Œ cancel å‡½æ•°ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜åˆ° Map å¯¹è±¡ä¸­ï¼Œä½¿ç”¨ Map å¯ä»¥å¿«é€Ÿçš„åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„è¯·æ±‚



[https://blog.csdn.net/weixin_45959525/article/details/105278347](https://blog.csdn.net/weixin_45959525/article/details/105278347)

