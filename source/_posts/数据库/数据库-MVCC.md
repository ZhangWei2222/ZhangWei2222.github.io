---
title: 数据库-MVCC
date: 2019-07-30 15:16:37
categories:
- 数据库
tags:
comments: false
---

## MVCC介绍
#### 1、定义
MVCC（Multi-Version Concurrency Control）：多版本并发控制机制

#### 2、与 传统的基于锁的并发控制 的区别
**读不上锁**：这种特性对于读多写少的场景，大大提高了系统的并发性。大部分关系型数据库都实现了MVCC

#### 3、MVCC的优点
大多数的MYSQL事务型存储引擎，如InnoDB等都不使用一种简单的行锁机制，会和MVCC一起使用。因为锁机制系统开销较大，**MVCC在大多数情况下能够代替行锁，大大降低系统开销**

#### 4、实现
MVCC是通过保存数据在某个时间点的快照实现的

MVCC没有正式的规范，各个数据库和存储引擎的实现都不尽相同

## InnoDB的MVCC实现

#### 1、原理
通过在每行记录后面保存两个隐藏的列来实现，这两个列，分别保存了行的创建时间和行的删除时间

> 注意：存储的不是具体的时间，而是系统版本号（可以理解为事务的ID），每开始一个新的事务，系统版本号就会自动递增。事务开始时刻的系统版本号就会作为事务的ID

#### 2、INSRT
新插入的每一行的创建时间：当前系统版本号

#### 3、DELETE
删除的每一行的删除时间：当前系统版本号

#### 4、SELECT
- 只会查找创建时间小于或等于当前版本号的行数
- 被删除行的删除时间需要未定义或大于当前版本号的行数

以上两种条件都必须满足

#### 5、UPDATE
实际上是新插入了一行记录，创建时间为当前系统版本号；同是把要UPDATE的行的删除时间更改为当前系统版本号