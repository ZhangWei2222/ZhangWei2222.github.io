---
title: JS 代码从敲下到执行过程发生了什么
date: 2020-07-29 11:18:37
categories:
- JavaScript
comments: true
---

## 前言

今天看了一篇文章：[从敲下一行JS代码到这行代码被执行，中间发生了什么？](https://mp.weixin.qq.com/s/VCy3yT3Ho-QQxNvUp5SwCg)。挺有意思，用自己的语言记录整理一下。

<!-- more -->



## 编译

计算机只认识机器指令码（0、1），其无法直接理解 JS 代码，需要一个中介帮忙解释并且将其翻译成机器指令码给计算机执行，这个过程叫编译。

不同的浏览器使用不同的 JS 引擎进行编译，浏览器兼容问题，就是由于使用的 JS 引擎不同，其能理解的 JS 语法不同，所以我们需要写好几种兼容语法。

<img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQQmSUOebD5zictOViarmUtwibebLEiaQCSR5n1KGjicBX9exicicrEneOAxYUTuiawxrkGAjH9jDAb71hhJ8A/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" style="zoom:67%;" />



## 编译原理

无论哪种 JS 引擎，其编译原理差不多

- **词法分析(laxical Analysis)** ：将代码切分成最小的单位，token。比如 `var a = 2;` 可以切分成 `var,a,=,2`
- **语法分析(Syntactic Analysis)** ：将词法单元转换成 AST 抽象语法树，一颗有层级，代表程序语法结构的树
  - 注意：词法分析和语法分析不是完全独立，而是**交错运行的**。一般都是每取得一个 token，就开始用语法分析器来处理了。
  - AST 是所有编译器以及转换器的基础核心，**常用的babel转码过程**：先将 ES6 代码转换成 AST，再转换成 ES5 的 AST，最后还原出 ES5 代码
  - 构建语法树，还能**发现语法错误**。 当 JS 解析器发现无法构造这个抽象语法树的时候，就会报语法错误，并结束整个代码块的解析
- **代码生成(Code Genaration)**：将 AST 转换成计算机可以识别的机器指令码。



#### V8 的编译过程

解析器生成 **AST** -> 用解释器 Ignition 根据语法树生成**字节码** （基于上面的过程又增加了这一步，因为直接生成机器指令码太占内存了） -> 用 TurboFan 将字节码生成**机器指令码**



## V8 为什么这么快

编译的过程很复杂，尤其 JS 还是动态语言，对于js引擎的性能要求就很高了。V8 做了很多事情来提升浏览器的性能，其中包括但不限于：

- 脚本流
  - 脚本一旦开始加载，V8 就在单独的线程解析，无需等待主线程，节省时间
- 字节码缓存
  - 访问同一个页面时复用之前生成的字节码，不再重新编译生成
- 内联
  - 将主函数中调用的函数，直接换成将要执行的内容
- 隐藏类
  - 通过隐藏类快速定位到动态加入的属性
  - **注意：动态加入的属性顺序不一样，会造成生成不同的隐藏类，我们动态赋值同一个构造函数对象的时候，尽量保证顺序也是一致的**
- 热点函数会被直接编译成机器码
  - 将常用的函数直接一步到位编成机器码
  - **注意：常用的函数传入的类型保持固定。并且对象的属性越稳定，越有利于性能**

