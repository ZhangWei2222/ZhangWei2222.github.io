---
title: 异步请求的队首阻塞
date: 2021-07-08 11:45:47
categories:
- Vue
comments: true
---

为什么请求是异步的，会造成阻塞？

<!-- more -->

## http 协议的队首阻塞

队首阻塞：队首的事情没有处理完，后面的都要等着



### HTTP1.0 的队首阻塞

- 发生在客户端

- 对于同一个 tcp 连接，所有请求放在队列中，只有前一个请求的响应受到了，才能发送下一个



### HTTP1.1 的队首阻塞

- 发生在服务端

- 使用了 Pipelining 管道技术 并行发送和处理多个请求（浏览器是默认关闭的）。使得客户端可以并行发送多个请求，服务端可以并行处理多个请求

- 但服务端在响应时，要严格按照接收请求的顺序发送。造成：如果最先收到的请求处理时间长，响应慢，就会阻塞已经生成了响应的发送

  - 为什么要严格按顺序发送响应？http是无状态的，并不知道响应对应的是哪个请求

  

### HTTP2 的队首阻塞

- 不使用管道技术，引入 帧、消息和数据流等概念，使用多路复用解决 http 队首阻塞
- 请求 / 响应过程
  - <img src="https://img-blog.csdnimg.cn/20201218093159920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTM3NjM0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:25%;" />
  - 每个请求/响应称为消息，每个消息拆分成若干个帧进行传输，每个帧都分配了一个序号
  - 每个帧在传输是属于一个数据流，一个连接可以存在多个流
  - 各个帧在流和连接上独立传输，到达后组装称消息，就避免了 请求/响应阻塞
- 底层使用 TCP 协议，可能出现 TCP 队首阻塞



## TCP 队首阻塞

- 传输过程中，可能丢包，一旦丢包就会等待重新发包，阻塞后续传输，这个问题虽然有滑动窗口这个方案，但是只能增强抗干扰，并没有彻底解决
- 解决：TCP 队首阻塞是因为 TCP 自身的实现机制决定的，无法避免。想要避免 TCP 队首阻塞，只有舍弃 TCP 协议
  - google 推出的 quic 协议，不使用 TCP 协议，而是在 UDP 协议的基础上实现了可靠传输。UDP是面向数据报的协议，数据报之间不会有阻塞约束
  - SCTP （流控制传输协议），和TCP、UDP 在同一层次的传输协议。多流特性可以尽可能避免队首阻塞的情况



## 总结

从 TCP 队首阻塞和 HTTP 队首阻塞 的原因，可以看出出现队首阻塞的原因：

1. 独立的消息数据都在一个链路上传输，也就是有一个 队列。比如 TCP 只有一个流，多个 HTTP 请求共用一个 TCP 连接
2. 队列上传输的数据有严格的顺序约束。比如 TCP 要求数据严格按照序号顺序，HTTP 管道化要求响应严格按照请求顺序返回

避免队首阻塞，需要从以上两个方面出发。比如 quic 协议不使用 TCP 使用 UDP，SCTP协议支持一个连接上存在多个数据流等

